@page "/"
@using System.Net.Http
@using System.Text.Json
@using System.Text.RegularExpressions
@using CodeAnalyzerWEB.Models
@inject IJSRuntime JSRuntime
@inject HttpClient Http

<div class="analyzer-page">
    <div class="container analyzer-container">
        <div class="analyzer-header">
            <div class="header-title">
                <h3>Анализатор проекта с критериями</h3>
            </div>
            <button class="clear-history-btn" @onclick="ClearAnalysisHistory" title="Очистить историю">
                <i class="bi bi-trash"></i>
            </button>
        </div>

        <!-- Форма ввода -->
        <div class="input-form">
            <div class="form-group">
                <label>Путь к папке проекта:</label>
                <input @bind="folderPath" placeholder="Введите путь к папке..." class="form-control" />
            </div>

            <div class="form-group">
                <label>Режим анализа:</label>
                <select @bind="analysisMode" class="form-control">
                    <option value="Structural">Структурный (быстрый)</option>
                    <option value="FullContent">Полный (с анализом содержимого)</option>
                </select>
            </div>

            <div class="form-group">
                <label>Использовать Ollama для анализа:</label>
                <div>
                    <input type="checkbox" @bind="useOllama" id="useOllama" />
                    <label for="useOllama" style="margin-left: 8px;">Использовать AI-анализ</label>
                </div>
            </div>

            <div class="form-group">
                <label>Критерии проверки:</label>
                <div class="criteria-list">
                    @foreach (var criterion in availableCriteria)
                    {
                        <div class="criterion-item">
                            <input type="checkbox"
                                   @bind="criterion.Selected"
                                   id="@criterion.Id" />
                            <label for="@criterion.Id">@criterion.Name</label>
                        </div>
                    }
                </div>
            </div>

            <div class="form-group">
                <label>Расширения файлов (через запятую):</label>
                <input @bind="extensionsInput" placeholder=".cs,.razor,.cshtml,.json" class="form-control" />
            </div>
        </div>

        <!-- Статус анализа -->
        <div class="analysis-status">
            @if (isAnalyzing)
            {
                <div class="status-info">
                    <div class="spinner"></div>
                    <span>Анализ выполняется...</span>
                </div>
            }
        </div>

        <!-- История анализа -->
        <ul class="analysis-history">
            @foreach (var message in analysisHistory)
            {
                <li class="@(message.Type == MessageType.User ? "user-message" : "bot-message")">
                    @if (message.Type == MessageType.User)
                    {
                        <div class="message-header">
                            <strong>Запрос анализа:</strong>
                        </div>
                        <div class="message-content">
                            <p><strong>Папка:</strong> @message.FolderPath</p>
                            <p><strong>Режим:</strong> @message.Mode</p>
                            <p><strong>Критерии:</strong> @string.Join(", ", message.Criteria)</p>
                            <p><strong>Ollama:</strong> @(message.UseOllama ? "Да" : "Нет")</p>
                        </div>
                    }
                    else
                    {
                        <div class="message-content formatted-content">
                            @if (message.Structure != null)
                            {
                                <div class="structure-summary">
                                    <h4>Структура проекта:</h4>
                                    <p>📁 Файлов: @message.Structure.TotalFiles</p>
                                    <p>🎮 Контроллеров: @message.Structure.TotalControllers</p>
                                    <p>📄 Страниц: @message.Structure.TotalPages</p>
                                    <p>🔄 Миграций: @message.Structure.Migrations.Count</p>
                                    <p>🗄️ DbContext: @message.Structure.DbContexts.Count</p>
                                    @if (message.Structure.HasDatabaseConnection)
                                    {
                                        <p>✅ Подключение к БД: Найдено</p>
                                    }
                                </div>
                            }

                            @if (message.Results?.Any() == true)
                            {
                                <div class="criteria-results">
                                    <h4>Результаты проверки критериев:</h4>
                                    @foreach (var result in message.Results)
                                    {
                                        <div class="result-item @(result.Passed ? "passed" : "failed")">
                                            <strong>@result.CriteriaName</strong>
                                            <span class="status-badge">@(result.Passed ? "✅ PASS" : "❌ FAIL")</span>
                                            <p>@result.Message</p>
                                            @if (result.Evidence?.Any() == true)
                                            {
                                                <details>
                                                    <summary>Детали</summary>
                                                    <ul>
                                                        @foreach (var evidence in result.Evidence)
                                                        {
                                                            <li>@evidence</li>
                                                        }
                                                    </ul>
                                                </details>
                                            }
                                        </div>
                                    }
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(message.Text))
                            {
                                @if (message.Text.Contains("❌ Ошибка"))
                                {
                                    <div class="error-message">
                                        @((MarkupString)FormatMarkdown(message.Text))
                                    </div>
                                }
                                else
                                {
                                    @((MarkupString)FormatMarkdown(message.Text))
                                }
                            }
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(message.Timestamp))
                    {
                        <div class="message-timestamp">
                            <small>@message.Timestamp</small>
                        </div>
                    }
                </li>
            }
        </ul>

        <!-- Кнопки управления -->
        <div class="input-container">
            <button @onclick="StartAnalysis" disabled="@isAnalyzing" class="btn btn-primary">
                @if (isAnalyzing)
                {
                    <span>Анализируется...</span>
                }
                else
                {
                    <span>Анализировать проект</span>
                }
            </button>

            <button @onclick="AnalyzeStructureOnly" disabled="@isAnalyzing" class="btn btn-secondary">
                Только структура
            </button>
        </div>
    </div>
</div>

@code {
    private List<AnalysisMessage> analysisHistory = new();
    private string folderPath = string.Empty;
    private string analysisMode = "Structural";
    private string extensionsInput = ".cs,.razor,.cshtml,.json";
    private bool isAnalyzing = false;
    private bool useOllama = true;

    private List<CriteriaOption> availableCriteria = new()
    {
        new CriteriaOption { Id = "controllers", Name = "Наличие контроллеров", Selected = true },
        new CriteriaOption { Id = "min_controllers", Name = "Минимум 3 контроллера", Selected = false },
        new CriteriaOption { Id = "pages", Name = "Наличие страниц", Selected = true },
        new CriteriaOption { Id = "min_pages", Name = "Минимум 2 страницы", Selected = false },
        new CriteriaOption { Id = "migrations", Name = "Наличие миграций", Selected = false },
        new CriteriaOption { Id = "dbcontext", Name = "Наличие DbContext", Selected = false },
        new CriteriaOption { Id = "config", Name = "Конфигурационные файлы", Selected = true }
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadAnalysisHistory();
    }

    private async Task LoadAnalysisHistory()
    {
        try
        {
            var historyJson = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "AnalysisHistory");
            if (!string.IsNullOrEmpty(historyJson))
            {
                analysisHistory = JsonSerializer.Deserialize<List<AnalysisMessage>>(historyJson) ?? new();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("Ошибка при загрузке истории: " + ex.Message);
        }

        if (!analysisHistory.Any())
        {
            analysisHistory.Add(new AnalysisMessage
                {
                    Text = "Введите путь к папке проекта и выберите критерии для анализа.",
                    Type = MessageType.Bot
                });
        }
    }

    private async Task SaveAnalysisHistory()
    {
        try
        {
            var historyJson = JsonSerializer.Serialize(analysisHistory);
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "AnalysisHistory", historyJson);
        }
        catch (Exception ex)
        {
            Console.WriteLine("Ошибка при сохранении истории: " + ex.Message);
        }
    }

    private async Task ClearAnalysisHistory()
    {
        analysisHistory.Clear();
        analysisHistory.Add(new AnalysisMessage
            {
                Text = "Введите путь к папке проекта и выберите критерии для анализа.",
                Type = MessageType.Bot
            });
        await SaveAnalysisHistory();
        StateHasChanged();
    }

    private List<AnalysisCriteria> GetSelectedCriteria()
    {
        var criteria = new List<AnalysisCriteria>();

        foreach (var option in availableCriteria.Where(o => o.Selected))
        {
            var criterion = new AnalysisCriteria
                {
                    Id = option.Id,
                    Name = option.Name,
                    Description = option.Name,
                    Type = CriteriaType.Structural,
                    CreatedAt = DateTime.UtcNow,
                    Rules = new List<CriteriaRule>()
                };

            // Добавляем правила в зависимости от критерия
            criterion.Rules.Add(new CriteriaRule
                {
                    Property = option.Id switch
                    {
                        "controllers" => "controllers",
                        "min_controllers" => "controllers_count",
                        "pages" => "pages",
                        "min_pages" => "pages_count",
                        "migrations" => "migrations",
                        "dbcontext" => "dbcontext",
                        "config" => "config_files",
                        _ => option.Id
                    },
                    Operator = option.Id switch
                    {
                        "min_controllers" => "greater_than",
                        "min_pages" => "greater_than",
                        _ => "exists"
                    },
                    Value = option.Id switch
                    {
                        "min_controllers" => "3",
                        "min_pages" => "2",
                        _ => ""
                    },
                    ErrorMessage = option.Id switch
                    {
                        "controllers" => "Контроллеры не найдены",
                        "min_controllers" => "Недостаточно контроллеров (требуется минимум 3)",
                        "pages" => "Страницы не найдены",
                        "min_pages" => "Недостаточно страниц (требуется минимум 2)",
                        "migrations" => "Миграции не найдены",
                        "dbcontext" => "DbContext не найден",
                        "config" => "Конфигурационные файлы не найдены",
                        _ => "Критерий не выполнен"
                    }
                });

            criteria.Add(criterion);
        }

        return criteria;
    }

    private async Task StartAnalysis()
    {
        if (string.IsNullOrWhiteSpace(folderPath))
            return;

        isAnalyzing = true;
        var selectedCriteria = GetSelectedCriteria();

        var userMessage = new AnalysisMessage
            {
                Type = MessageType.User,
                FolderPath = folderPath,
                Mode = analysisMode,
                Criteria = selectedCriteria.Select(c => c.Name).ToList(),
                UseOllama = useOllama,
                Timestamp = DateTime.Now.ToString("HH:mm:ss")
            };

        analysisHistory.Add(userMessage);
        await SaveAnalysisHistory();
        StateHasChanged();

        try
        {
            var request = new AnalysisRequest
                {
                    FolderPath = folderPath,
                    Mode = analysisMode == "Structural" ? AnalysisMode.Structural : AnalysisMode.FullContent,
                    Criteria = selectedCriteria,
                    Extensions = extensionsInput.Split(',').Select(e => e.Trim()).Where(e => !string.IsNullOrEmpty(e)).ToList(),
                    UseOllama = useOllama
                };

            var response = await Http.PostAsJsonAsync("https://localhost:7131/api/codeanalyzer/analyze", request);

            if (response.IsSuccessStatusCode)
            {
                var resultJson = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<AnalysisResponse>(resultJson, new JsonSerializerOptions
                    {
                        PropertyNameCaseInsensitive = true
                    });

                if (result?.Success == true)
                {
                    analysisHistory.Add(new AnalysisMessage
                        {
                            Type = MessageType.Bot,
                            Text = result.Result,
                            Timestamp = DateTime.Now.ToString("HH:mm:ss")
                        });
                }
                else
                {
                    analysisHistory.Add(new AnalysisMessage
                        {
                            Type = MessageType.Bot,
                            Text = result?.Error ?? "Неизвестная ошибка",
                            Timestamp = DateTime.Now.ToString("HH:mm:ss")
                        });
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                analysisHistory.Add(new AnalysisMessage
                    {
                        Type = MessageType.Bot,
                        Text = $"Ошибка сервера: {response.StatusCode}. {errorContent}",
                        Timestamp = DateTime.Now.ToString("HH:mm:ss")
                    });
            }
        }
        catch (Exception ex)
        {
            analysisHistory.Add(new AnalysisMessage
                {
                    Type = MessageType.Bot,
                    Text = $"Ошибка при выполнении запроса: {ex.Message}",
                    Timestamp = DateTime.Now.ToString("HH:mm:ss")
                });
        }
        finally
        {
            isAnalyzing = false;
            await SaveAnalysisHistory();
            StateHasChanged();
        }
    }

    private async Task AnalyzeStructureOnly()
    {
        if (string.IsNullOrWhiteSpace(folderPath))
            return;

        isAnalyzing = true;

        analysisHistory.Add(new AnalysisMessage
            {
                Type = MessageType.User,
                FolderPath = folderPath,
                Mode = "Structural",
                Criteria = new List<string> { "Только структура" },
                UseOllama = false,
                Timestamp = DateTime.Now.ToString("HH:mm:ss")
            });

        await SaveAnalysisHistory();
        StateHasChanged();

        try
        {
            var request = new StructureAnalysisRequest
                {
                    FolderPath = folderPath,
                    Extensions = extensionsInput.Split(',').Select(e => e.Trim()).Where(e => !string.IsNullOrEmpty(e)).ToList()
                };

            var response = await Http.PostAsJsonAsync("https://localhost:7131/api/codeanalyzer/analyze-structure", request);

            if (response.IsSuccessStatusCode)
            {
                var resultJson = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<StructureAnalysisResponse>(resultJson, new JsonSerializerOptions
                    {
                        PropertyNameCaseInsensitive = true
                    });

                if (result?.Success == true)
                {
                    analysisHistory.Add(new AnalysisMessage
                        {
                            Type = MessageType.Bot,
                            Structure = result.Structure,
                            Text = $"Структурный анализ завершен. Файлов: {result.Summary?.TotalFiles ?? 0}, Контроллеров: {result.Summary?.Controllers ?? 0}, Страниц: {result.Summary?.Pages ?? 0}",
                            Timestamp = DateTime.Now.ToString("HH:mm:ss")
                        });
                }
                else
                {
                    analysisHistory.Add(new AnalysisMessage
                        {
                            Type = MessageType.Bot,
                            Text = result?.Error ?? "Ошибка при структурном анализе",
                            Timestamp = DateTime.Now.ToString("HH:mm:ss")
                        });
                }
            }
            else
            {
                analysisHistory.Add(new AnalysisMessage
                    {
                        Type = MessageType.Bot,
                        Text = $"Ошибка сервера: {response.StatusCode}",
                        Timestamp = DateTime.Now.ToString("HH:mm:ss")
                    });
            }
        }
        catch (Exception ex)
        {
            analysisHistory.Add(new AnalysisMessage
                {
                    Type = MessageType.Bot,
                    Text = $"Ошибка: {ex.Message}",
                    Timestamp = DateTime.Now.ToString("HH:mm:ss")
                });
        }
        finally
        {
            isAnalyzing = false;
            await SaveAnalysisHistory();
            StateHasChanged();
        }
    }

    private string FormatMarkdown(string markdownText)
    {
        if (string.IsNullOrEmpty(markdownText))
            return string.Empty;

        // Базовая обработка markdown
        var formatted = Regex.Replace(markdownText, @"\*\*(.*?)\*\*", "<strong>$1</strong>");
        formatted = Regex.Replace(formatted, @"\*(.*?)\*", "<em>$1</em>");
        formatted = Regex.Replace(formatted, @"`(.*?)`", "<code>$1</code>");
        formatted = Regex.Replace(formatted, @"\n", "<br />");

        return formatted;
    }

    // Вспомогательные классы для UI
    public class AnalysisMessage
    {
        public string Text { get; set; } = string.Empty;
        public MessageType Type { get; set; }
        public string FolderPath { get; set; } = string.Empty;
        public string Mode { get; set; } = string.Empty;
        public List<string> Criteria { get; set; } = new();
        public bool UseOllama { get; set; }
        public ProjectStructure Structure { get; set; }
        public List<CriteriaCheckResult> Results { get; set; } = new();
        public string Timestamp { get; set; } = string.Empty;
    }

    public class CriteriaOption
    {
        public string Id { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public bool Selected { get; set; }
    }

    public enum MessageType
    {
        User,
        Bot
    }

    // Классы для запросов API
    public class AnalysisRequest
    {
        public string FolderPath { get; set; } = string.Empty;
        public List<AnalysisCriteria> Criteria { get; set; } = new();
        public List<string> Extensions { get; set; } = new();
        public AnalysisMode Mode { get; set; }
        public bool UseOllama { get; set; }
    }

    public class StructureAnalysisRequest
    {
        public string FolderPath { get; set; } = string.Empty;
        public List<string> Extensions { get; set; } = new();
    }

    public class AnalysisResponse
    {
        public bool Success { get; set; }
        public string Result { get; set; } = string.Empty;
        public string Error { get; set; } = string.Empty;
    }

    public class StructureAnalysisResponse
    {
        public bool Success { get; set; }
        public ProjectStructure Structure { get; set; }
        public StructureSummary Summary { get; set; }
        public string Error { get; set; } = string.Empty;
    }

    public class StructureSummary
    {
        public int TotalFiles { get; set; }
        public int Controllers { get; set; }
        public int Pages { get; set; }
        public int Migrations { get; set; }
        public int DbContexts { get; set; }
        public int Services { get; set; }
        public bool HasDatabaseConnection { get; set; }
        public int DatabaseConnectionsCount { get; set; }
        public int MigrationCommandsCount { get; set; }
    }
}

<style>
    .analyzer-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .analyzer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .input-form {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-control {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .criteria-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 10px;
    }

    .criterion-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .analysis-history {
        list-style: none;
        padding: 0;
        margin: 0 0 20px 0;
    }

    .user-message, .bot-message {
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 8px;
    }

    .user-message {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
    }

    .bot-message {
        background: #f5f5f5;
        border-left: 4px solid #4caf50;
    }

    .message-header {
        margin-bottom: 10px;
    }

    .message-timestamp {
        margin-top: 10px;
        text-align: right;
        color: #666;
    }

    .structure-summary, .criteria-results {
        margin-bottom: 15px;
    }

    .result-item {
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
        border-left: 4px solid;
    }

        .result-item.passed {
            background: #e8f5e8;
            border-left-color: #4caf50;
        }

        .result-item.failed {
            background: #ffebee;
            border-left-color: #f44336;
        }

    .status-badge {
        float: right;
        font-weight: bold;
    }

    .error-message {
        color: #d32f2f;
        background: #ffebee;
        padding: 10px;
        border-radius: 4px;
        border-left: 4px solid #f44336;
    }

    .input-container {
        display: flex;
        gap: 10px;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-primary {
        background: #007bff;
        color: white;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .spinner {
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3498db;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 2s linear infinite;
        display: inline-block;
        margin-right: 10px;
    }

    @@keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .clear-history-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
    }

        .clear-history-btn:hover {
            background: #c82333;
        }
</style>